```{r}
load("./strokeStudy.RData")
```

```{r}
library(ggplot2)
library(dplyr)
library(nlme)
library(broom)
library(knitr)
library(stringr)
library(tidyverse)
library(janitor)
library(naniar)
library(mice)
```

# EDA
```{r}
x <- x %>% clean_names()%>%
  rename(emsvscar = em_svs_car)
str(x)
```

missingness per variable
```{r}
x %>% 
  summarise(across(everything(), ~ sum(is.na(.)))) %>% 
  pivot_longer(everything(),
               names_to = "variable",
               values_to = "n_missing") %>%
  arrange(desc(n_missing))
```

missingness aggregated by site
```{r}
x %>%
  group_by(site_id) %>%
  summarise(across(everything(), ~ mean(is.na(.)))) %>%
  pivot_longer(-site_id, names_to = "variable", values_to = "prop_missing") %>%
  ggplot(aes(x = variable, y = site_id, fill = prop_missing)) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Missingness by Site")
```

```{r}
x %>%
  ggplot(aes(x = home_or_rehab, y = age, fill = home_or_rehab)) +
  geom_boxplot() +
  labs(title = "Age Differences by Outcome")
```

```{r}
x %>% 
  ggplot(aes(x = gender, fill = home_or_rehab)) +
  geom_bar(position = "fill") +
  labs(y = "Proportion", 
       title = "Outcome by Gender")

```

```{r}
x %>% 
  ggplot(aes(x = race2, fill = home_or_rehab)) +
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = "Proportion", 
       title = "Outcome by Race")
```

```{r}
x <- x %>%
  mutate(ems_label = case_when(
    emsvscar == 1 ~ "EMS Arrival",
    emsvscar == 0 ~ "Car Arrival",
    TRUE ~ "Missing"
  ))
x %>% 
  ggplot(aes(x = ems_label, fill = home_or_rehab)) +
  geom_bar(position = "dodge") +
  labs(title = "Outcome by Arrival Method",
       x = "Arrival Method",
       y = "Count",
       fill = "Good Outcome") +
  scale_fill_manual(values = c("FALSE" = "tomato", "TRUE" = "steelblue"))
```

missingness by quarter
```{r}
x %>%
  group_by(time2) %>%
  summarise(across(everything(), ~ mean(is.na(.)))) %>%
  pivot_longer(-time2, names_to = "variable", values_to = "prop_missing") %>%
  ggplot(aes(variable, time2, fill = prop_missing)) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Missingness by Quarter")
```

missingness correlation plot
```{r}
vis_miss(x)
```

age missingness by site x quarter

```{r}
x %>%
  mutate(age_missing = is.na(age)) %>%
  group_by(site_id, time2) %>%
  summarise(prop_age_missing = mean(age_missing), .groups = "drop") %>%
  ggplot(aes(x = time2, y = site_id, fill = prop_age_missing)) +
  geom_tile(color = "white") +
  scale_fill_viridis_c(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Share of Records Missing Age by Site and Quarter",
    fill = "Percent\nMissing"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Can clearly see that this is not MCAR; its MAR.

# Missing data + Frequentist model

use predictive mean matching by drawing 20 multiply imputed data sets

```{r}
impute_vars <- x %>%
  select(home_or_rehab, age, gender, race2, emsvscar, pre_hosp_notify,
         had_tpa, had_thrombectomy, tpa_complic, thr_complic,
         site_id, time2)

meth <- make.method(impute_vars)
meth["age"] <- "pmm"

pred <- make.predictorMatrix(impute_vars)
pred["age", ] <- 0
pred["age", c("gender", "race2", "emsvscar", "pre_hosp_notify",
              "had_tpa", "had_thrombectomy", "tpa_complic",
              "thr_complic", "site_id", "time2", "home_or_rehab")] <- 1

set.seed(2025)
imp <- mice(
  impute_vars,
  m = 20,
  maxit = 20,
  method = meth,
  predictorMatrix = pred,
  seed = 2025,
  printFlag = FALSE
)

imp
```
constructs 20 predictive-mean-matching imputations for Age using the specified covariates

```{r}
fit1_mi <- with(
  imp,
  glm(
    home_or_rehab ~ age + gender + race2 + emsvscar + pre_hosp_notify +
      had_tpa + had_thrombectomy + tpa_complic + thr_complic + time2,
    family = binomial
  )
)

pool(fit1_mi) %>% summary(conf.int = TRUE, exponentiate = TRUE)
```
fits the logistic model within each imputed dataset and pools odds ratios that respect imputation uncertainty.

# Frequentist model diagnostics

# Bayesian model
