---
title: "STA 440 Case 4: Root Growth"
author: "Yura Heo, Anirudh Jain, Richard Jiang"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
format: 
  pdf:
    documentclass: article
    fontsize: 11pt
geometry: margin=1in
execute: 
  warning: false
  message: false
  echo: false
---

# Background and Motivation

Researchers developed a new stroke awareness program with the goal of reducing the time needed to provide patients with life-saving acute stroke care delivery. The investigation was divided into two time periods: the pre-treatment period, during which researchers developed the program, and the program implementation period, which overlapped with the onset of the COVID-19 pandemic. The goals of the investigation are twofold: to determine the factors associated with “good” stroke care outcomes, defined as a discharge to home or a rehabilitation facility, and to determine if the implementation of the program improved patient outcomes.

# Data and Exploratory Data Analysis

The researchers tracked stroke patient data from 2019-2020 on a quarterly basis, recording a variety of covariate variables, patient demographic information, and the hospital site where treatment took place. The resulting data set had missing data: therefore, it was necessary for us to develop an approach to handling the missingness before creating any models. In the exploratory analysis phase, we sought to first determine if data missingness was missing at random, missing completely at random, or missing not at random. Our findings on data missingness were used to inform our approach to creating an appropriate model for patient outcomes. Because one goal of the investigation is to determine the effectiveness of the program implementation relative to pre-implementation, we divided the time into three periods: a baseline period (Y1Q1-Y1Q2), a middle transition period as the program was first implemented (Y1Q3-Y2Q2), and the final implementation period (Y2Q3-Y2Q4), where the effects of the program might be the most detectable. 

To begin our analysis, we first sought to determine which variables were most frequently missing. Figure 1 reveals that the 4 variables with missing data were, in descending order, patient age, whether the patient was transported to the hospital via car or EMS, if the hospital was notified prior to patient arrival if they were transported by EMS, and patient race. To determine whether the data is missing completely at random, we investigated whether there were patterns to the missingness. Figures 2 and 3 are heatmaps visualizing the proportion of data missing from the variables. Figure 2 displays the proportion of missingness in each variable by our three time periods, while Figure 3 displays variable missingness by hospital site. Inspection of Figure 2 reveals that data missingness appears worse for certain time quarters, most severely with missing age in the first period. Figure 3 reveals that certain hospitals, namely site IDs 140, 150, and 170, had high variable missingness, with age being the most frequently missing.



# Model Rationale and Implementation

### Model Rationale
To address missing data based on our exploratory findings, we implemented a fully Bayesian joint model that simultaneously imputes missing values and estimats associations, following the factorization:


### Model Implementation

### Model Evaluation

# Results
```{r}
posterior_stats <- posterior_summary$statistics %>%
  as.data.frame() %>%
  tibble::rownames_to_column("parameter")

posterior_quants <- posterior_summary$quantiles %>%
  as.data.frame() %>%
  tibble::rownames_to_column("parameter")

posterior_table <- posterior_stats %>%
  dplyr::select(parameter, Mean, SD) %>%
  left_join(
    posterior_quants %>%
      dplyr::select(parameter, `2.5%`, `50%`, `97.5%`),
    by = "parameter"
  ) %>%
  filter(
    stringr::str_detect(
      parameter,
      "^(beta_(age|tpa|thr|ems|not|time|race)|sigma_site_out)"
    )
  )


posterior_odd_ratios_table <- posterior_table %>%
  filter(stringr::str_detect(parameter, "^beta")) %>%
  mutate(
    OR_mean = exp(Mean),
    OR_low  = exp(`2.5%`),
    OR_high = exp(`97.5%`)
  ) %>%
  dplyr::select(parameter, OR_mean, OR_low, OR_high) %>%
  arrange(parameter) %>%
  knitr::kable(digits = 3, caption = "Posterior odds ratios for key covariates.")

```

The posterior summary Table (@tbl-posterior-table) and the (@tbl-posterior-odd-ratios-table) indicate several strong associations. Each additional year of age is associated with roughly a 6-7% decrease in the odds or a good discharge outcome (OR = 0.94), Patients arriving via EMS had about 65% lower odds of being discharged home or to  rehabilitation compared to those arriving by car (OR = 0.34) consistent with EMS patients having more severe strokes. Complications were among the strongest predictors of poor outcomes: thrombectomy complications were associated with an approximately 89% reduction in the odds of a good discharge, and tPA complications with a 75% reduction. Race differences were also noticable: African American patients had about 35% lower odds of good outcomes compared to Caucasian patients.   


Time effects provided insight into whether outcomes improved over the study period. Compared with baseline, the mid-study period and final periods were associated with roughly 20-30% higher odds of a good discharge outcome. When translated into predicted probabilities for a reference patient (female, Caucasian, median age(70), car arrival, no complications, average site), the model estimates an absolute improvement of about 2-4 percent points from baseline to the final study period. Taken together with the residual and calibration diagnostics, these findings suggest modest but consistent evidence that outcomes improved over time. 


# Conclusion

# Limitations and Future Directions

# Appendix
```{r}
#| label: tbl-posterior-table
#| fig-cap: "Posterior means and 95% credible intervals."
posterior_table |>
  knitr::kable(digits = 3)
```


```{r}
#| label: tbl-posterior-odd-ratios-table
#| fig-cap: "Posterior odds ratios for key covariates."
posterior_odd_ratios_table |>
  knitr::kable(digits = 3)
```

